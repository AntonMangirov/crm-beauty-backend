# Геокодинг адресов

## Описание

Утилита для преобразования адресов в географические координаты (широта и долгота) через Nominatim API (OpenStreetMap).

## Использование

### Базовый геокодинг

```typescript
import { geocodeAddress } from './utils/geocoding';

const coordinates = await geocodeAddress('Москва, Красная площадь, 1');
if (coordinates) {
  console.log(`Координаты: ${coordinates.lat}, ${coordinates.lng}`);
}
```

### Геокодинг с кешированием в БД

```typescript
import { geocodeAndCache } from './utils/geocoding';
import prisma from './prismaClient';

// Автоматически проверит БД и сохранит результат
const coordinates = await geocodeAndCache(prisma, userId, address);
```

## Особенности

- **Бесплатный сервис**: Nominatim API от OpenStreetMap
- **Rate limiting**: Автоматическое соблюдение лимита 1 запрос/секунду
- **Кеширование**: Результаты сохраняются в БД (поля `lat` и `lng` в модели `User`)
- **Автоматическое обновление**: При изменении адреса координаты обновляются автоматически

## Ограничения Nominatim

- Rate limit: 1 запрос в секунду (соблюдается автоматически)
- Требуется User-Agent заголовок
- Точность может варьироваться в зависимости от региона
- Для российских адресов точность может быть ниже, чем у специализированных сервисов

## Альтернативные сервисы

Если нужна большая точность для российских адресов, можно заменить на:

1. **Yandex Geocoder API** (платный)
   - Высокая точность для России
   - Требуется API ключ
   - ~1000 бесплатных запросов/день

2. **DaData** (платный)
   - Очень высокая точность для России
   - Требуется API ключ
   - Платные тарифы

## Миграция на другой сервис

Для замены Nominatim на другой сервис:

1. Создайте новую функцию геокодинга в `geocoding.ts`
2. Обновите `geocodeAddress()` для использования нового API
3. Формат ответа должен оставаться `{ lat: number, lng: number }`

## Автоматический геокодинг

При обновлении адреса пользователя через API, координаты можно обновить автоматически:

```typescript
// В контроллере обновления профиля
import { geocodeAndCache } from '../utils/geocoding';

if (address) {
  await geocodeAndCache(prisma, userId, address);
}
```

## База данных

Координаты хранятся в таблице `User`:
- `lat` - широта (DECIMAL(10,8))
- `lng` - долгота (DECIMAL(11,8))

Оба поля опциональны (nullable).

