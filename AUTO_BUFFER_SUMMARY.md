# Автоматический межуслуговой буфер - Сводка

## ✅ Реализовано

### 1. Добавлено поле `autoBuffer` в `MasterSettings`

**Файл**: `src/utils/slotCalculator.ts`

```typescript
export interface MasterSettings {
  // ... другие поля
  autoBuffer?: boolean; // Автоматический межуслуговой буфер между любыми процедурами
}
```

### 2. Обновлен интерфейс `ExistingBooking`

Добавлено поле `serviceId` для определения индивидуального буфера услуги:

```typescript
export interface ExistingBooking {
  start: string;
  end: string;
  serviceId?: string; // ID услуги для определения буфера
}
```

### 3. Обновлена функция `mergeBusyIntervals`

**Логика работы**:

1. **Буфер после услуги**: Каждое бронирование получает буфер после завершения
   - Используется индивидуальный буфер услуги (`service.bufferMinutes`) если есть
   - Иначе используется общий буфер (`serviceBufferMinutes`)

2. **Автоматический буфер**: Если `autoBuffer: true`
   - Вычисляется промежуток между концом текущего бронирования (с буфером) и началом следующего
   - Если промежуток < автоматического буфера → расширяем текущее бронирование
   - Если промежуток >= автоматического буфера → добавляем отдельный интервал автоматического буфера

3. **Объединение интервалов**: 
   - Все пересекающиеся интервалы (бронирования, буферы, перерывы) автоматически объединяются
   - Пересортировка после добавления автоматических буферов

4. **Границы рабочего интервала**:
   - Буферы, выходящие за рабочий интервал, обрезаются функцией `subtractBusyIntervals`

### 4. Обновлен контроллер

**Файл**: `src/controllers/publicController.ts`

- Загружает `serviceId` для каждого бронирования
- Передает `autoBuffer: false` по умолчанию (TODO: загружать из БД)

## Примеры использования

См. файл `AUTO_BUFFER_EXAMPLES.md` для подробных примеров расчетов:
- Автоматический буфер между услугами
- Объединение с перерывами
- Обработка границ рабочего интервала
- Различные сценарии с множественными услугами

## Ключевые особенности

✅ **Буфер после услуги**: Всегда учитывается для каждого бронирования
✅ **Автоматический буфер**: Добавляется между любыми процедурами если `autoBuffer: true`
✅ **Объединение**: Пересекающиеся интервалы автоматически объединяются
✅ **Границы**: Буферы не выходят за рабочий интервал
✅ **Индивидуальные буферы**: Учитываются буферы конкретных услуг

## Готово к использованию

✅ Алгоритм обновлен
✅ Логика автоматического буфера реализована
✅ Примеры расчетов документированы
✅ Обратная совместимость сохранена (`autoBuffer` опциональный, по умолчанию `false`)




