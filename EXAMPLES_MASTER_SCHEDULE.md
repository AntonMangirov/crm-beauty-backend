# Примеры использования расписания мастера

## Обновленный контроллер

Контроллер `getTimeslots` в `publicController.ts` теперь загружает настройки мастера из БД и передает их в функцию `calculateAvailableSlots`.

### Логика обработки настроек

1. **workSchedule**: Если `null` → используется fallback `[{ start: '09:00', end: '18:00' }]`
2. **breaks**: Если `null` → используется пустой массив `[]`
3. **defaultBufferMinutes**: Если `null` → используется `15`
4. **slotStepMinutes**: Если `null` → используется `15`
5. **timezone**: Из заголовка запроса `X-Timezone` или `'Europe/Moscow'` по умолчанию

## Пример JSON мастера в БД

### Пример 1: Мастер с полным расписанием

```json
{
  "id": "clx1234567890",
  "isActive": true,
  "workSchedule": [
    {
      "dayOfWeek": 1,
      "intervals": [
        { "from": "09:00", "to": "13:00" },
        { "from": "14:00", "to": "19:00" }
      ]
    },
    {
      "dayOfWeek": 2,
      "intervals": [
        { "from": "09:00", "to": "18:00" }
      ]
    },
    {
      "dayOfWeek": 3,
      "intervals": [
        { "from": "10:00", "to": "14:00" },
        { "from": "15:00", "to": "20:00" }
      ]
    },
    {
      "dayOfWeek": 4,
      "intervals": [
        { "from": "09:00", "to": "18:00" }
      ]
    },
    {
      "dayOfWeek": 5,
      "intervals": [
        { "from": "09:00", "to": "18:00" }
      ]
    }
  ],
  "breaks": [
    {
      "from": "13:00",
      "to": "14:00",
      "reason": "Обед"
    },
    {
      "from": "15:30",
      "to": "15:45",
      "reason": "Кофе-брейк"
    }
  ],
  "defaultBufferMinutes": 20,
  "slotStepMinutes": 10
}
```

### Пример 2: Мастер без настроек (используются дефолты)

```json
{
  "id": "clx9876543210",
  "isActive": true,
  "workSchedule": null,
  "breaks": null,
  "defaultBufferMinutes": null,
  "slotStepMinutes": null
}
```

**Результат**: Будут использованы fallback значения:
- `workIntervals`: `[{ start: '09:00', end: '18:00' }]`
- `breaks`: `[]`
- `defaultBufferMinutes`: `15`
- `slotStepMinutes`: `15`

### Пример 3: Мастер с частичными настройками

```json
{
  "id": "clx5555555555",
  "isActive": true,
  "workSchedule": [
    {
      "dayOfWeek": 1,
      "intervals": [
        { "from": "10:00", "to": "17:00" }
      ]
    }
  ],
  "breaks": null,
  "defaultBufferMinutes": 30,
  "slotStepMinutes": 15
}
```

**Результат**:
- Для понедельника: `workIntervals`: `[{ start: '10:00', end: '17:00' }]`
- Для других дней: fallback `[{ start: '09:00', end: '18:00' }]`
- `breaks`: `[]` (null → пустой массив)
- `defaultBufferMinutes`: `30`
- `slotStepMinutes`: `15`

## Примеры результатов генерации слотов

### Пример 1: Понедельник с двумя рабочими интервалами

**Запрос**: `GET /api/public/master-slug/timeslots?date=2025-01-27&serviceId=svc123`

**Данные мастера**:
```json
{
  "workSchedule": [
    {
      "dayOfWeek": 1,
      "intervals": [
        { "from": "09:00", "to": "13:00" },
        { "from": "14:00", "to": "19:00" }
      ]
    }
  ],
  "breaks": [
    { "from": "13:00", "to": "14:00", "reason": "Обед" }
  ],
  "defaultBufferMinutes": 15,
  "slotStepMinutes": 15
}
```

**Существующие записи**:
- `10:00 - 11:00` (услуга 60 минут)
- `15:30 - 16:30` (услуга 60 минут)

**Услуга**: `durationMin: 60`, `bufferMinutes: 15` (общий буфер)

**Результат** (часовой пояс: `Europe/Moscow`):
```json
{
  "available": [
    "2025-01-27T06:00:00.000Z",  // 09:00 MSK
    "2025-01-27T06:15:00.000Z",  // 09:15 MSK
    "2025-01-27T06:30:00.000Z",  // 09:30 MSK
    "2025-01-27T06:45:00.000Z",  // 09:45 MSK
    "2025-01-27T07:00:00.000Z",  // 10:00 MSK - занято
    "2025-01-27T07:15:00.000Z",  // 10:15 MSK - занято
    "2025-01-27T07:30:00.000Z",  // 10:30 MSK - занято
    "2025-01-27T07:45:00.000Z",  // 10:45 MSK - занято
    "2025-01-27T08:00:00.000Z",  // 11:00 MSK - занято
    "2025-01-27T08:15:00.000Z",  // 11:15 MSK
    "2025-01-27T08:30:00.000Z",  // 11:30 MSK
    "2025-01-27T08:45:00.000Z",  // 11:45 MSK
    "2025-01-27T09:00:00.000Z",  // 12:00 MSK
    "2025-01-27T09:15:00.000Z",  // 12:15 MSK
    "2025-01-27T09:30:00.000Z",  // 12:30 MSK
    "2025-01-27T09:45:00.000Z",  // 12:45 MSK
    // Перерыв 13:00-14:00
    "2025-01-27T11:00:00.000Z",  // 14:00 MSK
    "2025-01-27T11:15:00.000Z",  // 14:15 MSK
    "2025-01-27T11:30:00.000Z",  // 14:30 MSK
    "2025-01-27T11:45:00.000Z",  // 14:45 MSK
    "2025-01-27T12:00:00.000Z",  // 15:00 MSK
    "2025-01-27T12:15:00.000Z",  // 15:15 MSK
    "2025-01-27T12:30:00.000Z",  // 15:30 MSK - занято
    "2025-01-27T12:45:00.000Z",  // 15:45 MSK - занято
    "2025-01-27T13:00:00.000Z",  // 16:00 MSK - занято
    "2025-01-27T13:15:00.000Z",  // 16:15 MSK - занято
    "2025-01-27T13:30:00.000Z",  // 16:30 MSK - занято
    "2025-01-27T13:45:00.000Z",  // 16:45 MSK
    "2025-01-27T14:00:00.000Z",  // 17:00 MSK
    "2025-01-27T14:15:00.000Z",  // 17:15 MSK
    "2025-01-27T14:30:00.000Z",  // 17:30 MSK
    "2025-01-27T14:45:00.000Z"   // 17:45 MSK
  ]
}
```

**Объяснение**:
- Слоты генерируются с шагом 15 минут
- Учитываются два рабочих интервала: 09:00-13:00 и 14:00-19:00
- Перерыв 13:00-14:00 исключен
- Занятые слоты (10:00-11:00 и 15:30-16:30) исключены
- Буфер 15 минут учитывается при проверке доступности

### Пример 2: Вторник с дефолтным расписанием

**Запрос**: `GET /api/public/master-slug/timeslots?date=2025-01-28&serviceId=svc123`

**Данные мастера**:
```json
{
  "workSchedule": null,
  "breaks": null,
  "defaultBufferMinutes": null,
  "slotStepMinutes": null
}
```

**Результат** (используются fallback значения):
```json
{
  "available": [
    "2025-01-28T06:00:00.000Z",  // 09:00 MSK
    "2025-01-28T06:15:00.000Z",  // 09:15 MSK
    "2025-01-28T06:30:00.000Z",  // 09:30 MSK
    // ... каждые 15 минут до 18:00
    "2025-01-28T14:45:00.000Z"   // 17:45 MSK
  ]
}
```

**Объяснение**:
- Используется fallback расписание: 09:00-18:00
- Шаг слотов: 15 минут (дефолт)
- Буфер: 15 минут (дефолт)
- Перерывов нет

### Пример 3: Среда с кастомным шагом и буфером

**Запрос**: `GET /api/public/master-slug/timeslots?date=2025-01-29&serviceId=svc123`

**Данные мастера**:
```json
{
  "workSchedule": [
    {
      "dayOfWeek": 3,
      "intervals": [
        { "from": "10:00", "to": "17:00" }
      ]
    }
  ],
  "breaks": [],
  "defaultBufferMinutes": 30,
  "slotStepMinutes": 10
}
```

**Результат**:
```json
{
  "available": [
    "2025-01-29T07:00:00.000Z",  // 10:00 MSK
    "2025-01-29T07:10:00.000Z",  // 10:10 MSK
    "2025-01-29T07:20:00.000Z",  // 10:20 MSK
    "2025-01-29T07:30:00.000Z",  // 10:30 MSK
    // ... каждые 10 минут до 17:00
    "2025-01-29T13:50:00.000Z"   // 16:50 MSK
  ]
}
```

**Объяснение**:
- Шаг слотов: 10 минут (кастомный)
- Буфер: 30 минут (кастомный)
- Рабочий интервал: 10:00-17:00
- Слоты генерируются каждые 10 минут

### Пример 4: Пятница с несколькими перерывами

**Запрос**: `GET /api/public/master-slug/timeslots?date=2025-01-31&serviceId=svc123`

**Данные мастера**:
```json
{
  "workSchedule": [
    {
      "dayOfWeek": 5,
      "intervals": [
        { "from": "09:00", "to": "18:00" }
      ]
    }
  ],
  "breaks": [
    { "from": "13:00", "to": "14:00", "reason": "Обед" },
    { "from": "15:30", "to": "15:45", "reason": "Кофе-брейк" }
  ],
  "defaultBufferMinutes": 15,
  "slotStepMinutes": 15
}
```

**Результат** (фрагмент):
```json
{
  "available": [
    "2025-01-31T06:00:00.000Z",  // 09:00 MSK
    // ... слоты до 13:00
    "2025-01-31T09:45:00.000Z",  // 12:45 MSK
    // Перерыв 13:00-14:00
    "2025-01-31T11:00:00.000Z",  // 14:00 MSK
    "2025-01-31T11:15:00.000Z",  // 14:15 MSK
    // ... слоты до 15:30
    "2025-01-31T12:15:00.000Z",  // 15:15 MSK
    // Перерыв 15:30-15:45
    "2025-01-31T12:45:00.000Z",  // 15:45 MSK
    // ... слоты до 18:00
    "2025-01-31T14:45:00.000Z"   // 17:45 MSK
  ]
}
```

**Объяснение**:
- Перерывы исключены из доступных слотов
- Слоты генерируются только в свободное время

## Структура данных в БД

### workSchedule (JSONB)
```typescript
type WorkSchedule = Array<{
  dayOfWeek: number; // 0 = воскресенье, 1 = понедельник, ..., 6 = суббота
  intervals: Array<{
    from: string; // "HH:mm" формат
    to: string;   // "HH:mm" формат
  }>;
}>;
```

### breaks (JSONB)
```typescript
type Breaks = Array<{
  from: string;    // "HH:mm" формат
  to: string;      // "HH:mm" формат
  reason?: string; // Опциональная причина
}>;
```

## Примечания

1. **Часовой пояс**: Используется из заголовка `X-Timezone` или `'Europe/Moscow'` по умолчанию
2. **День недели**: Вычисляется для целевой даты запроса (UTC)
3. **Fallback**: Если расписание не найдено для дня недели, используется дефолтное 09:00-18:00
4. **Null значения**: Все null значения обрабатываются с fallback логикой








