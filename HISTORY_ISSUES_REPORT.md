# –û—Ç—á–µ—Ç –æ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ç–æ—á–∫–∞—Ö –∏—Å—Ç–æ—Ä–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2025-01-XX  
**–°—Ç–∞—Ç—É—Å:** ‚ùå **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –û–ë–ù–ê–†–£–ñ–ï–ù–´**

---

## üìã –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. ‚ùå **–ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤ Prisma** - —É–¥–∞–ª—è–µ—Ç –≤—Å–µ Appointment –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Service/Client
2. ‚ùå **–ù–µ—Ç —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –≤ Appointment** - –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è —É—Å–ª—É–≥–∏ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. ‚ùå **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π** - –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Service –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ PENDING/CONFIRMED
4. ‚ùå **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ null** - –∫–æ–¥ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É Service –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
5. ‚ö†Ô∏è **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Service** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç appointment.service –Ω–∞–ø—Ä—è–º—É—é
6. ‚ö†Ô∏è **safeDeleteClient –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** - —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤ Prisma Schema

**–§–∞–π–ª:** `prisma/schema.prisma`  
**–°—Ç—Ä–æ–∫–∏:** 110-112

```prisma
model Appointment {
  master     User       @relation(fields: [masterId], references: [id], onDelete: Cascade)
  client     Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service    Service    @relation(fields: [serviceId], references: [id], onDelete: Cascade)
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ `Service` ‚Üí –≤—Å–µ `Appointment` —É–¥–∞–ª—è—é—Ç—Å—è –∫–∞—Å–∫–∞–¥–Ω–æ (–≤–∫–ª—é—á–∞—è COMPLETED, CANCELED, NO_SHOW)
- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ `Client` ‚Üí –≤—Å–µ `Appointment` —É–¥–∞–ª—è—é—Ç—Å—è –∫–∞—Å–∫–∞–¥–Ω–æ (–≤–∫–ª—é—á–∞—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ)
- **–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ç–µ—Ä—è–µ—Ç—Å—è**

**–†–∏—Å–∫:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô** - –ø–æ–ª–Ω–∞—è –ø–æ—Ç–µ—Ä—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

---

### 2. –£–¥–∞–ª–µ–Ω–∏–µ Service –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π

**–§–∞–π–ª:** `src/controllers/servicesController.ts`  
**–°—Ç—Ä–æ–∫–∏:** 182-201

```typescript
const activeAppointments = await prisma.appointment.findFirst({
  where: {
    serviceId: id,
    status: {
      in: ['PENDING', 'CONFIRMED'],
    },
  },
});

if (activeAppointments) {
  return res.status(400).json({
    error: 'Cannot delete service with active appointments',
  });
}

await prisma.service.delete({
  where: { id },
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (PENDING, CONFIRMED)
- –ó–∞–ø–∏—Å–∏ COMPLETED, CANCELED, NO_SHOW **–ù–ï –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è**
- –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π ‚Üí Service —É–¥–∞–ª—è–µ—Ç—Å—è ‚Üí –∫–∞—Å–∫–∞–¥ —É–¥–∞–ª—è–µ—Ç **–í–°–ï** Appointment

**–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö:**

1. –£—Å–ª—É–≥–∞ –∏–º–µ–µ—Ç 10 –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π (COMPLETED) –∏ 0 –∞–∫—Ç–∏–≤–Ω—ã—Ö
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç (–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π)
3. Service —É–¥–∞–ª—è–µ—Ç—Å—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏
4. –ö–∞—Å–∫–∞–¥ Prisma —É–¥–∞–ª—è–µ—Ç –≤—Å–µ 10 –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π
5. –ò—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ—Ç–µ—Ä—è–Ω–∞

**–†–∏—Å–∫:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**

---

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –≤ Appointment

**–§–∞–π–ª:** `prisma/schema.prisma`  
**–°—Ç—Ä–æ–∫–∏:** 95-119

**–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```prisma
model Appointment {
  id               String     @id @default(cuid())
  masterId         String
  clientId         String
  serviceId        String      // ‚Üê –°—Å—ã–ª–∫–∞ –Ω–∞ Service
  startAt          DateTime
  endAt            DateTime
  status           AppointmentStatus
  price            Decimal?    // ‚Üê –ï—Å—Ç—å —Å–Ω–∞–ø—à–æ—Ç —Ü–µ–Ω—ã
  // ‚ùå –ù–ï–¢: serviceName
  // ‚ùå –ù–ï–¢: serviceDuration
  // ‚ùå –ù–ï–¢: servicePrice (–µ—Å—Ç—å —Ç–æ–ª—å–∫–æ price, –Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞—Å—Ç–æ–º–Ω–∞—è —Ü–µ–Ω–∞)
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –ù–µ—Ç –ø–æ–ª–µ–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è —É—Å–ª—É–≥–∏ (`serviceName`)
- –ù–µ—Ç –ø–æ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (`serviceDuration`)
- –ï—Å—Ç—å `price`, –Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞—Å—Ç–æ–º–Ω–∞—è —Ü–µ–Ω–∞, –∞ –Ω–µ —Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏
- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Service –∏—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–ø–æ–ª–Ω–æ–π –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–π

**–†–∏—Å–∫:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô** - –∏—Å—Ç–æ—Ä–∏—è –Ω–µ–ø–æ–ª–Ω–∞—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Service

---

### 4. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ null –≤ getClientHistory

**–§–∞–π–ª:** `src/controllers/meController.ts`  
**–°—Ç—Ä–æ–∫–∏:** 1128-1135

```typescript
const historyItems = appointments.map((appointment, index) => {
  // ...
  return {
    id: appointment.id,
    date: appointment.startAt,
    service: {
      id: appointment.service.id, // ‚ùå –û–®–ò–ë–ö–ê –µ—Å–ª–∏ service = null
      name: appointment.service.name, // ‚ùå –û–®–ò–ë–ö–ê –µ—Å–ª–∏ service = null
      price: Number(appointment.service.price), // ‚ùå –û–®–ò–ë–ö–ê –µ—Å–ª–∏ service = null
    },
    status: appointment.status,
    photos: relatedPhotos,
  };
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –ï—Å–ª–∏ Service —É–¥–∞–ª–µ–Ω, Prisma –≤–µ—Ä–Ω–µ—Ç `appointment.service = null`
- –ö–æ–¥ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `appointment.service.id/name/price` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
- **–í—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É:** `Cannot read property 'id' of null`
- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

**–†–∏—Å–∫:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô** - –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –∏—Å—Ç–æ—Ä–∏–∏

---

### 5. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Service –Ω–∞–ø—Ä—è–º—É—é

**–§–∞–π–ª—ã:**

- `src/components/ClientHistoryModal.tsx` (—Å—Ç—Ä–æ–∫–∏ 389, 393)
- `src/components/AppointmentDetailsModal.tsx` (—Å—Ç—Ä–æ–∫–∏ 236, 239)
- `src/pages/CalendarPage/index.tsx` (—Å—Ç—Ä–æ–∫–∞ 1118)

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```typescript
// ClientHistoryModal.tsx
<Typography variant="body1">
  {item.service.name}  // ‚ùå –ï—Å–ª–∏ Service —É–¥–∞–ª–µ–Ω ‚Üí –æ—à–∏–±–∫–∞
</Typography>
<Typography variant="body2">
  {item.service.price.toLocaleString("ru-RU")} ‚ÇΩ  // ‚ùå –ï—Å–ª–∏ Service —É–¥–∞–ª–µ–Ω ‚Üí –æ—à–∏–±–∫–∞
</Typography>
```

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `appointment.service.name/price` –Ω–∞–ø—Ä—è–º—É—é
- –ï—Å–ª–∏ Service —É–¥–∞–ª–µ–Ω, —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
- –ù–µ—Ç fallback –∑–Ω–∞—á–µ–Ω–∏–π

**–†–∏—Å–∫:** üü° **–í–´–°–û–ö–ò–ô** - –æ—à–∏–±–∫–∏ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

---

## ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–´ –°–†–ï–î–ù–ï–ô –ö–†–ò–¢–ò–ß–ù–û–°–¢–ò

### 6. safeDeleteClient –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–§–∞–π–ª:** `src/utils/clientHelpers.ts`  
**–°—Ç—Ä–æ–∫–∏:** 16-35

```typescript
export async function safeDeleteClient(clientId: string) {
  const appointments = await prisma.appointment.findFirst({
    where: { clientId },
  });

  if (appointments) {
    throw new Error(
      'Cannot delete client with existing appointments. Client has appointment history and cannot be deleted.'
    );
  }

  return await prisma.client.update({
    where: { id: clientId },
    data: { isActive: false },
  });
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –§—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É
- **–ù–û:** –Ω–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- Endpoint –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (—ç—Ç–æ —Ö–æ—Ä–æ—à–æ)
- –ù–æ –µ—Å–ª–∏ endpoint –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é

**–†–∏—Å–∫:** üü° **–°–†–ï–î–ù–ò–ô** - –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ –±—É–¥—É—â–µ–º

---

### 7. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ Client, –∞ –Ω–µ –∫ Appointment

**–§–∞–π–ª:** `prisma/schema.prisma`  
**–°—Ç—Ä–æ–∫–∏:** 121-132

```prisma
model Photo {
  id        String   @id @default(cuid())
  clientId  String   // ‚Üê –ü—Ä–∏–≤—è–∑–∫–∞ –∫ Client
  url       String
  // ‚ùå –ù–ï–¢: appointmentId
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –§–æ—Ç–æ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ `Client`, –∞ –Ω–µ –∫ `Appointment`
- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Client –≤—Å–µ —Ñ–æ—Ç–æ —É–¥–∞–ª—è—é—Ç—Å—è –∫–∞—Å–∫–∞–¥–Ω–æ
- –í –∏—Å—Ç–æ—Ä–∏–∏ —Ñ–æ—Ç–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –∑–∞–ø–∏—Å—è–º –ø–æ –¥–∞—Ç–µ (–ª–æ–≥–∏–∫–∞ –≤ `meController.ts:1106-1126`)
- –ï—Å–ª–∏ Client —É–¥–∞–ª–µ–Ω, —Ñ–æ—Ç–æ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã, –¥–∞–∂–µ –µ—Å–ª–∏ Appointment –æ—Å—Ç–∞–ª–∏—Å—å –±—ã

**–†–∏—Å–∫:** üü° **–°–†–ï–î–ù–ò–ô** - —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π

---

## ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û

### 1. –ü–æ–ª–µ isActive —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

- ‚úÖ `Service.isActive` - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (schema.prisma:60)
- ‚úÖ `Client.isActive` - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (schema.prisma:80)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö:
  - `getClients` —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ `isActive: true`
  - `getServices` —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ `isActive: true`
  - –ü—É–±–ª–∏—á–Ω—ã–µ API —Ñ–∏–ª—å—Ç—Ä—É—é—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —É—Å–ª—É–≥–∏

**–ù–û:** –§–∏–∑–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ `deleteService`

---

### 2. Endpoint —É–¥–∞–ª–µ–Ω–∏—è Client –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

- ‚úÖ –ù–µ—Ç endpoint –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ `src/routes/me.ts`
- ‚úÖ –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –∏—Å—Ç–æ—Ä–∏–µ–π

**–ù–û:** –ö–∞—Å–∫–∞–¥ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## üìä –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–±–ª–µ–º

| #   | –ü—Ä–æ–±–ª–µ–º–∞                                | –§–∞–π–ª                   | –°—Ç—Ä–æ–∫–∏    | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å    | –†–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö |
| --- | --------------------------------------- | ---------------------- | --------- | -------------- | ------------------ |
| 1   | –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ Appointment          | schema.prisma          | 110-112   | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è | –í—ã—Å–æ–∫–∏–π            |
| 2   | –£–¥–∞–ª–µ–Ω–∏–µ Service –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏   | servicesController.ts  | 182-201   | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è | –í—ã—Å–æ–∫–∏–π            |
| 3   | –ù–µ—Ç —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –≤ Appointment             | schema.prisma          | 95-119    | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è | –í—ã—Å–æ–∫–∏–π            |
| 4   | –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ null –≤ getClientHistory | meController.ts        | 1128-1135 | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è | –°—Ä–µ–¥–Ω–∏–π            |
| 5   | –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Service             | ClientHistoryModal.tsx | 389, 393  | üü° –í—ã—Å–æ–∫–∞—è     | –°—Ä–µ–¥–Ω–∏–π            |
| 6   | safeDeleteClient –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è        | clientHelpers.ts       | 16-35     | üü° –°—Ä–µ–¥–Ω—è—è     | –ù–∏–∑–∫–∏–π             |
| 7   | –§–æ—Ç–æ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ Client                 | schema.prisma          | 121-132   | üü° –°—Ä–µ–¥–Ω—è—è     | –°—Ä–µ–¥–Ω–∏–π            |

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 1.1. –î–æ–±–∞–≤–∏—Ç—å —Å–Ω–∞–ø—à–æ—Ç—ã –≤ Appointment

**–ú–∏–≥—Ä–∞—Ü–∏—è:**

```prisma
model Appointment {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  serviceName     String?   // –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–ø–∏—Å–∏
  serviceDuration Int?      // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–ø–∏—Å–∏ (–º–∏–Ω—É—Ç—ã)
  servicePrice    Decimal?  @db.Decimal(10, 2) // –¶–µ–Ω–∞ —É—Å–ª—É–≥–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–ø–∏—Å–∏
}
```

**–û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è Appointment:**

- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Appointment —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–Ω–∞–ø—à–æ—Ç—ã –∏–∑ Service
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ Service –ù–ï –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–Ω–∞–ø—à–æ—Ç—ã –≤ Appointment (–∏—Å—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è)

#### 1.2. –ò–∑–º–µ–Ω–∏—Ç—å onDelete —Å Cascade –Ω–∞ Restrict –∏–ª–∏ SetNull

**–í–∞—Ä–∏–∞–Ω—Ç 1: Restrict (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ)**

```prisma
model Appointment {
  service    Service    @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  client     Client     @relation(fields: [clientId], references: [id], onDelete: Restrict)
}
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: SetNull (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–Ω–∞–ø—à–æ—Ç—ã)**

```prisma
model Appointment {
  serviceId  String?
  service    Service?   @relation(fields: [serviceId], references: [id], onDelete: SetNull)
}
```

#### 1.3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å deleteService - –ø—Ä–æ–≤–µ—Ä—è—Ç—å –í–°–ï –∑–∞–ø–∏—Å–∏

```typescript
const appointmentsCount = await prisma.appointment.count({
  where: { serviceId: id },
});

if (appointmentsCount > 0) {
  return res.status(400).json({
    error: 'Cannot delete service with existing appointments',
    message: `This service has ${appointmentsCount} appointment(s). Consider deactivating it instead.`,
  });
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å soft delete –≤–º–µ—Å—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
await prisma.service.update({
  where: { id },
  data: { isActive: false },
});
```

#### 1.4. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ null –≤ getClientHistory

```typescript
const historyItems = appointments.map((appointment, index) => {
  // ...
  return {
    id: appointment.id,
    date: appointment.startAt,
    service: appointment.service
      ? {
          id: appointment.service.id,
          name: appointment.service.name,
          price: Number(appointment.service.price),
        }
      : {
          // Fallback –Ω–∞ —Å–Ω–∞–ø—à–æ—Ç—ã, –µ—Å–ª–∏ Service —É–¥–∞–ª–µ–Ω
          id: appointment.serviceId,
          name: appointment.serviceName || '–£—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞',
          price: Number(appointment.servicePrice || appointment.price || 0),
        },
    status: appointment.status,
    photos: relatedPhotos,
  };
});
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –í—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 2.1. –û–±–Ω–æ–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å null Service

- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `appointment.service` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–Ω–∞–ø—à–æ—Ç—ã –∫–∞–∫ fallback

#### 2.2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å safeDeleteClient –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ endpoint —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞

- –ï—Å–ª–∏ endpoint –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `safeDeleteClient`
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å soft delete (isActive = false)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 3.1. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–≤—è–∑–∫—É Photo –∫ Appointment

- –î–æ–±–∞–≤–∏—Ç—å `appointmentId` –≤ Photo (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ –¥–∞–∂–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Client

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ò–ò

**–§–∞–π–ª:** `HISTORY_PRESERVATION_AUDIT.md`

### –ß—Ç–æ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:

- ‚úÖ –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ –º–æ–¥–µ–ª–∏ (Service, Client, Appointment, Photo)
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ, —á—Ç–æ –∏—Å—Ç–æ—Ä–∏—è –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
- ‚úÖ –í—ã—è–≤–ª–µ–Ω—ã –≤—Å–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–µ—Å—Ç–∞

### –°—Ç–∞—Ç—É—Å: ‚úÖ **–ê–£–î–ò–¢ –í–´–ü–û–õ–ù–ï–ù –ö–û–†–†–ï–ö–¢–ù–û**

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏

### Middleware –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ

- ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ middleware –≤ `src/middleware/`
- ‚úÖ –ù–µ—Ç middleware, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç –∏–ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è
- ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ –≤ –ª–æ–≥–∏–∫–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –∏ —Å—Ö–µ–º–µ Prisma

### –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ API

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `GET /api/me/clients/:id/history` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `GET /api/me/appointments` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å null

---

## üîí –í—ã–≤–æ–¥—ã

**–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚ùå **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –û–ë–ù–ê–†–£–ñ–ï–ù–´**

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤ Prisma —É–¥–∞–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Service/Client
2. –ù–µ—Ç —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –≤ Appointment –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥–∏
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Service
4. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ null –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –∏—Å—Ç–æ—Ä–∏–∏
5. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Service –Ω–∞–ø—Ä—è–º—É—é

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å —Å–Ω–∞–ø—à–æ—Ç—ã –≤ Appointment
2. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:** –ò–∑–º–µ–Ω–∏—Ç—å onDelete —Å Cascade –Ω–∞ Restrict
3. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å deleteService –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
4. **–°—Ä–æ—á–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ null –≤ getClientHistory
5. **–í–∞–∂–Ω–æ:** –û–±–Ω–æ–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å null Service

**–†–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**










